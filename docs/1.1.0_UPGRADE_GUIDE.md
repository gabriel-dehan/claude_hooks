# Upgrading to v1.1.0

Version 1.1.0 adds new features to align with Anthropic's updated Claude Code Hooks documentation. **All changes are backward compatible** - existing hooks continue to work without modification.

## What's New

### 1. New PermissionRequest Hook

Handle permission request events from Claude Code:

```ruby
class PermissionGuard < ClaudeHooks::PermissionRequest
  def call
    if dangerous_tool?
      deny_permission!("Requires manual approval")
    else
      allow_permission!("Safe to proceed")
    end
    output
  end

  private

  def dangerous_tool?
    %w[rm git-reset curl].include?(tool_name)
  end
end
```

**When to use**: Create permission guards that automatically approve/deny permission requests based on custom logic.

### 2. New Fields Available

All hooks now receive these additional fields:

- **`permission_mode`** (all hooks): Access via `permission_mode` method
  - Values: `'default'`, `'plan'`, `'acceptEdits'`, `'dontAsk'`, `'bypassPermissions'`
  - Defaults to `'default'`

- **`tool_use_id`** (PreToolUse, PostToolUse, PermissionRequest): Access via `tool_use_id` method
  - Unique identifier for each tool use (e.g., `"toolu_01ABC123..."`)

- **`notification_type`** (Notification): Access via `notification_type` method
  - Values: `'permission_prompt'`, `'idle_prompt'`, `'auth_success'`, `'elicitation_dialog'`

**Example usage:**

```ruby
class MyHook < ClaudeHooks::PreToolUse
  def call
    log "Permission mode: #{permission_mode}"
    log "Tool use ID: #{tool_use_id}"

    # Adjust behavior based on permission mode
    if permission_mode == 'bypassPermissions'
      # More restrictive checks
      deny_permission!("Cannot bypass for sensitive operations")
    else
      approve_tool!("Approved")
    end

    output
  end
end
```

### 3. Update Tool Input (PreToolUse)

Modify tool input before execution:

```ruby
class InputModifier < ClaudeHooks::PreToolUse
  def call
    case tool_name
    when 'Bash'
      # Add safety flags to bash commands
      if tool_input['command']&.include?('rm')
        sanitized = tool_input.merge('command' => "#{tool_input['command']} --interactive")
        update_tool_input!(sanitized)
      else
        approve_tool!("Safe command")
      end
    when 'Write'
      # Validate file paths
      if tool_input['file_path']&.start_with?('/etc')
        deny_permission!("Cannot write to /etc")
      else
        approve_tool!("Safe write")
      end
    else
      approve_tool!("No special handling")
    end

    output
  end
end
```

**Output helpers:**
- `output.input_updated?` - Check if input was modified
- `output.updated_input` - Get the updated input hash

## Do I Need to Change My Existing Hooks?

**No!** All changes are backward compatible:

- New fields have sensible defaults (return `nil` or `'default'`)
- Existing methods continue to work exactly as before
- No breaking changes to any APIs
- Your existing hooks will work with v1.1.0 without any modifications

## Should I Update My Hooks?

Consider updating if:

- ✅ You want to handle PermissionRequest events
- ✅ You need to check the current permission mode
- ✅ You want to modify tool inputs dynamically
- ✅ You need to differentiate notification types
- ✅ You want to track specific tool use instances via IDs

## New Hook Type Summary

| Hook Type | When It Runs | Key Methods |
|-----------|--------------|-------------|
| **PermissionRequest** | When Claude requests permission | `allow_permission!`, `deny_permission!`, `update_input_and_allow!` |

## New Fields Summary

| Field | Available In | Purpose |
|-------|--------------|---------|
| `permission_mode` | All hooks | Know the current permission mode |
| `tool_use_id` | PreToolUse, PermissionRequest, PostToolUse | Track specific tool use instances |
| `notification_type` | Notification | Filter notifications by type |

## New PreToolUse Features

| Feature | Method | Description |
|---------|--------|-------------|
| Update input | `update_tool_input!(hash)` | Modify tool input and auto-approve |
| Check if updated | `output.input_updated?` | Boolean check for modification |
| Get updated input | `output.updated_input` | Retrieve the modified input |

## Testing

All existing tests should pass without modification. Run:

```bash
bundle exec rake test
# or
ruby test/run_all_tests.rb
```

## Migration Examples

### Example 1: Using permission_mode

**Before (v1.0.x):**
```ruby
class GitGuard < ClaudeHooks::PreToolUse
  def call
    if tool_name == 'Bash' && tool_input['command']&.include?('git push')
      ask_for_permission!("Git push requires confirmation")
    else
      approve_tool!("Approved")
    end
    output
  end
end
```

**After (v1.1.0 - enhanced):**
```ruby
class GitGuard < ClaudeHooks::PreToolUse
  def call
    if tool_name == 'Bash' && tool_input['command']&.include?('git push')
      # Skip asking in dontAsk mode, but still log
      if permission_mode == 'dontAsk'
        log "Auto-approving git push in dontAsk mode", level: :warn
        approve_tool!("Auto-approved due to permission mode")
      else
        ask_for_permission!("Git push requires confirmation")
      end
    else
      approve_tool!("Approved")
    end
    output
  end
end
```

### Example 2: Using PermissionRequest

**Before (v1.0.x):**
```ruby
# Permission requests couldn't be handled automatically
```

**After (v1.1.0 - new capability):**
```ruby
class AutoPermissionGuard < ClaudeHooks::PermissionRequest
  SAFE_TOOLS = %w[ls cat grep find read].freeze

  def call
    if SAFE_TOOLS.include?(tool_name)
      allow_permission!("Safe tool, auto-approved")
    else
      # Let user decide
      deny_permission!("Requires manual approval")
    end
    output
  end
end
```

### Example 3: Updating tool input

**Before (v1.0.x):**
```ruby
class BashSanitizer < ClaudeHooks::PreToolUse
  def call
    # Could only approve or deny, not modify
    if tool_input['command']&.include?('rm')
      block_tool!("Dangerous command blocked")
    else
      approve_tool!("Safe")
    end
    output
  end
end
```

**After (v1.1.0 - new capability):**
```ruby
class BashSanitizer < ClaudeHooks::PreToolUse
  def call
    if tool_input['command']&.include?('rm')
      # Add safety flags instead of blocking
      safe_command = "#{tool_input['command']} --interactive --verbose"
      update_tool_input!({'command' => safe_command})
      log "Added safety flags to rm command"
    else
      approve_tool!("Safe")
    end
    output
  end
end
```

## Questions?

- See the [full CHANGELOG](../CHANGELOG.md) for all changes
- Check the [API documentation](API/) for detailed method references
- Review the [PermissionRequest API](API/PERMISSION_REQUEST.md) for the new hook type
- Look at [example implementations](../example_dotclaude/) for patterns

## Rollback

If you need to rollback to v1.0.2:

```bash
gem uninstall claude_hooks
gem install claude_hooks -v 1.0.2
```

Or in your Gemfile:
```ruby
gem 'claude_hooks', '~> 1.0.2'
```
